---
name: EdenPacketARM
on:  # yamllint disable-line rule:truthy
  push:
    branches: [packet-workflow]
# yamllint disable rule:line-length
jobs:
  integration:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        conf: [ "c2.large.arm" ]
        hv: ["kvm"]
    steps:
      - name: Setup packages
        run: |
          sudo rm -rf /etc/apt/sources.list.d/microsoft-prod.list /etc/apt/sources.list.d/microsoft-prod.list.save
          sudo add-apt-repository ppa:longsleep/golang-backports
          sudo apt install -y golang-1.16 jq expect
      - name: Get eden
        uses: actions/checkout@v2
      - name: Create ssh key
        run: |
          mkdir -p ~/.ssh/keys/
          echo "$SSH_PRIVATE_KEY" > "$SSH_KEY_PATH"
          sudo chmod 600 "$SSH_KEY_PATH"
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ./shell-scripts/packet/ssh-add.sh "$SSH_KEY_PATH" "$SSH_PASSPHRASE"
          ssh-keyscan -H 147.75.55.170 > ~/.ssh/known_hosts
        env:
          SSH_PRIVATE_KEY: ${{secrets.PACKET_SSH_KEY}}
          SSH_PASSPHRASE: ${{secrets.PACKET_SSH_PASSPHRASE}}
          SSH_KEY_PATH: ${{ github.workspace }}/../private.key
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
      - name: Get and setup eden on packet
        run: |
          echo -e "#!/bin/bash\n ssh root@147.75.55.170 $@" > ./ssh.sh && chmod 777 ./ssh.sh
          echo -e "#!/bin/bash\n ssh root@147.75.55.170 cd eden && $@" > ssh-eden.sh  && chmod 777 ./ssh-eden.sh
          ./ssh.sh 'sudo add-apt-repository ppa:longsleep/golang-backports'
          ./ssh.sh 'sudo apt install -y golang-1.16 jq expect git'
          ./ssh.sh "git clone https://github.com/lf-edge/eden.git -b $GITHUB_SHA"
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock